<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eburon Transcription Portal</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #1a1a1a;
            --accent: #4ade80;
            --text: #eeeeee;
            --text-dim: #888888;
        }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
        }
        header {
            margin-bottom: 40px;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .status { font-size: 14px; color: var(--text-dim); margin-top: 8px; }
        
        #transcription-list {
            flex: 1;
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            overflow-y: auto;
            border: 1px solid #333;
            margin-bottom: 30px;
        }
        .msg { margin-bottom: 15px; line-height: 1.6; }
        .msg .time { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
        .msg .text { font-size: 18px; color: var(--accent); }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
        }
        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: black;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.stop { background: #ef4444; color: white; }

        .docs {
            background: #111;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #222;
        }
        .docs h2 { font-size: 16px; margin-top: 0; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
        code { background: #333; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: var(--accent); }
        .msg-placeholder { color: var(--text-dim); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Eburon Transcriber</h1>
            <div id="status" class="status">Connecting to 168.231.78.113:8765...</div>
        </header>

        <div id="transcription-list">
            <div class="msg">
                <div class="text msg-placeholder">Transcription will appear here...</div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn">Start Recording</button>
            <button id="stopBtn" class="stop" disabled>Stop</button>
        </div>

        <div class="docs">
            <h2>Developer API</h2>
            <p>Fetch the latest transcription in plain text:</p>
            <code>GET http://168.231.78.113:8765/transcription</code>
        </div>
    </div>

    <script>
        const VPS_WS = "ws://168.231.78.113:8765/ws";
        let ws;
        let mediaRecorder;
        let audioContext;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const listEl = document.getElementById('transcription-list');

        async function initRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                
                // Connect to WebSocket
                ws = new WebSocket(VPS_WS);
                
                ws.onopen = () => {
                    statusEl.textContent = "Connected & Listening...";
                    statusEl.style.color = "#4ade80";
                    
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0 && ws.readyState === WebSocket.OPEN) {
                            ws.send(e.data);
                        }
                    };
                    mediaRecorder.start(250); // Send chunks every 250ms
                };

                ws.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    if (data.type === "transcription") {
                        appendTranscription(data.text);
                    }
                };

                ws.onclose = () => {
                    statusEl.textContent = "Connection Closed";
                    statusEl.style.color = "#ef4444";
                    stopRecording();
                };

            } catch (err) {
                console.error(err);
                alert("Could not access microphone.");
            }
        }

        function appendTranscription(text) {
            const div = document.createElement('div');
            div.className = 'msg';
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<div class="time">${time}</div><div class="text">${text}</div>`;
            listEl.appendChild(div);
            listEl.scrollTop = listEl.scrollHeight;
        }

        function stopRecording() {
            if (mediaRecorder) mediaRecorder.stop();
            if (ws) ws.close();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusEl.textContent = "Ready";
            statusEl.style.color = "";
        }

        startBtn.onclick = () => {
            startBtn.disabled = true;
            stopBtn.disabled = false;
            initRecording();
        };

        stopBtn.onclick = stopRecording;
    </script>
</body>
</html>
